<style type="text/css">
body {
    font-size: 12px;
    font-color: #333;
    font-family:Helvetica,Arial,sans-serif;
    background: #d5e4f7;
    padding: 2px;
}
textarea{
    border: 1px solid #b7c5e3;
    margin: 0;
    height: 64px;
    width: 320px;
    resize: none;
    background: #f0f5fb;
    -webkit-border-radius: 5px;
    -moz-border-radius: 5px;
    padding: 2px;
    font-size: 12px;
    position: relative;
    z-index: 10;
}
textarea:focus {
    background: #fff;
}
textarea.full {
    border-color: #f60;
}

#d_clip_container span {
    background: #aaa; /*background: #f60;*/
    display: inline-block;
    padding: 2px 5px;
    color: #fff;
    -moz-border-radius: 3px;
    -webkit-border-radius: 3px;
     cursor: pointer;
}

span {
    display: inline-block;
    padding: 5px 5px;    
    border: 1px solid #d5e4f7;
    -webkit-border-radius: 3px;
     cursor: pointer;
}
span:hover{border:1px solid #b7c5e3;}
#clean {
	width:75%; 
	color: #fff;
	text-align:center; 
	/*border:1px solid black; */
	background-color:#aaa; 	
	-moz-border-radius: 3px;
	-webkit-border-radius: 3px;
	margin:5px; padding:5px; 
        }
#clean.hover { background-color:#eee; }
#clean.active { background-color:#aaa; }


</style>
<script type="text/javascript" >

function $(id) { return document.getElementById(id); }
		
addEventListener('load', function()
{
	var laurl = '';
	var titulo ='';
	//get current location for settings page
	var xtsurl=location.href;
	xtsurl=xtsurl.substring(0,xtsurl.length-11);
	$('settings').innerHTML='<a href="'+xtsurl+'/options.html'+'">Settings</a>';
	//finds data about the current tab
	chrome.tabs.getSelected(null,function(tab) {
		laurl=tab.url;
		titulo=tab.title;
	});
	//reads  options
	var user=localStorage['username'];
	if(user){
		if(user.length>0){
		$('user').innerHTML='@'+user+'<br />';
		$('postwit').style.display='';
		//$('stwit').style.display='none';
		}
	}
	var pass=localStorage['password'];
	if(!pass){
		$('user').innerHTML=$('user').innerHTML+'<br />No password information.';
	}
	var includetitle=localStorage['includetitle'];
		
	//read the url shorteners
	
	//Bit.Ly
	var op_bitly = localStorage['bitly'];
	var bitlyid = localStorage['bitlyid'];
	var bitlyapi = localStorage['bitlyapi'];
	if(op_bitly=='true'){
		var p = document.createElement('span');
		p.id='bitly';
		p.innerHTML = '<img src="bit.ly.png" atitle="Bit.Ly"/>';
		$('user').appendChild(p);	
	}	
	var bitly = $('bitly');
	if (bitly) {
		bitly.addEventListener("click", function() {
			xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(){
				if(xhr.readyState == 4 && xhr.status==200){
					//let's parse resultant shor url
					var bitlyresult = xhr.responseText;
					var bitlypos=bitlyresult.search('"shortUrl": "http://bit.ly/');
					if(bitlypos!=-1){
						bitlyresult = bitlyresult.substring(bitlypos+13);
						bitlypos=bitlyresult.search('"');
						if(bitlypos!=-1){
							bitlyresult = bitlyresult.substring(0,bitlypos);
						}						
					}else{
						bitlyresult="Error!";
					}
					if(includetitle=='true')
					$("fe_text").innerHTML = titulo+' '+ bitlyresult;
					else
					$("fe_text").innerHTML = bitlyresult;					
					var bitlyp = $('bitlyp');					
					$('user').removeChild(bitlyp);
					$("fe_text").select();
					$("fe_text").focus();						
				}		
			}
			var bitlyp=document.createElement('span');
			bitlyp.innerHTML = 'Shortening please wait...';
			bitlyp.id='bitlyp';
			$('user').appendChild(bitlyp);
			xhr.open('GET','http://api.bit.ly/shorten?version=2.0.1&longUrl='+encodeURIComponent(laurl)+'&login='+bitlyid+'&apiKey='+bitlyapi,true);
			xhr.send(null);			
		}, false);
	}
	//IS.GD
	var op_isgd = localStorage['isgd'];
	if(op_isgd=='true'){
		var p = document.createElement('span');
		p.id='isgd';
		p.innerHTML = '<img src="is.gd.png" />';
		$('user').appendChild(p);	
	}	
	var isgd = $('isgd');
	if (isgd) {
		isgd.addEventListener("click", function() {
			xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(){
				if(xhr.readyState == 4 && xhr.status==200){
					if(includetitle=='true')
					$("fe_text").innerHTML = titulo+' '+ xhr.responseText;					
					else
					$("fe_text").innerHTML = xhr.responseText;										
					var isgdp = $('isgdp');					
					$('user').removeChild(isgdp);
					$("fe_text").select();
					$("fe_text").focus();						
				}		
			}
			var isgdp=document.createElement('span');
			isgdp.innerHTML = 'Shortening please wait...';
			isgdp.id='isgdp';
			$('user').appendChild(isgdp);
			xhr.open('GET','http://is.gd/api.php?longurl='+encodeURIComponent(laurl),true);
			xhr.send(null);			
		}, false);
	}
	//IR.PE
	var op_irpe = localStorage['irpe'];
	if(op_irpe=='true'){
		var p = document.createElement('span');
		p.id='irpe';
		p.innerHTML = '<img src="ir.pe.png" />';
		$('user').appendChild(p);	
	}	
	var irpe = $('irpe');
	if (irpe) {
		irpe.addEventListener("click", function() {
			xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(){
				if(xhr.readyState == 4 && xhr.status==200){
					if(includetitle=='true')
					$("fe_text").innerHTML = titulo+' '+ xhr.responseText;
					else $("fe_text").innerHTML = xhr.responseText;					
					var irpep = $('irpep');					
					$('user').removeChild(irpep);
					$("fe_text").select();
					$("fe_text").focus();					
				}		
			}
			var irpep=document.createElement('span');
			irpep.innerHTML = 'Shortening please wait...';
			irpep.id='irpep';
			$('user').appendChild(irpep);
			xhr.open('GET','http://ir.pe/?url='+encodeURIComponent(laurl)+'&api=1',true);
			xhr.send(null);			
		}, false);
	}
	//TinyURL
	var op_tiny = localStorage['tiny'];
	if(op_tiny=='true'){
		var p = document.createElement('span');
		p.id='tiny';
		p.innerHTML = '<img src="tinyurl.bmp" />';
		$('user').appendChild(p);	
	}	
	var tiny = $('tiny');
	if (tiny) {
		tiny.addEventListener("click", function() {
			xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(){
				if(xhr.readyState == 4 && xhr.status==200){
					if(includetitle=='true')
					$("fe_text").innerHTML = titulo+' '+ xhr.responseText;
					else
					$("fe_text").innerHTML = xhr.responseText;										
					var tinyp = $('tinyp');					
					$('user').removeChild(tinyp);
					$("fe_text").select();
					$("fe_text").focus();					
				}		
			}
			var tinyp=document.createElement('span');
			tinyp.innerHTML = 'Shortening please wait...';
			tinyp.id='tinyp';
			$('user').appendChild(tinyp);
			xhr.open('GET','http://tinyurl.com/api-create.php?url='+encodeURIComponent(laurl),true);
			xhr.send(null);			
		}, false);
	}
	//TR.IM
	var op_trim = localStorage['trim'];
	if(op_trim=='true'){
		var p = document.createElement('span');
		p.id='trim';
		p.innerHTML = '<img src="tr.im.png" />';
		$('user').appendChild(p);	
	}	
	var trim = $('trim');
	if (trim) {
		trim.addEventListener("click", function() {
			xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(){
				if(xhr.readyState == 4 && xhr.status==200){
					if(includetitle=='true')
					$("fe_text").innerHTML = titulo+' '+ xhr.responseText;
					else
					$("fe_text").innerHTML = xhr.responseText;					
					var trimp = $('trimp');					
					$('user').removeChild(trimp);
					$("fe_text").select();
					$("fe_text").focus();					
				}		
			}
			var trimp=document.createElement('span');
			trimp.innerHTML = 'Shortening please wait...';
			trimp.id='trimp';
			$('user').appendChild(trimp);
			xhr.open('GET','http://api.tr.im/v1/trim_simple?url='+encodeURIComponent(laurl),true);
			xhr.send(null);			
		}, false);
	}
	//CLI.GS
	var op_cligs = localStorage['cligs'];
	if(op_cligs=='true'){
		var p = document.createElement('span');
		p.id='cligs';
		p.innerHTML = '<img src="cligs.png" />';
		$('user').appendChild(p);	
	}	
	var cligs = $('cligs');
	if (cligs) {
		cligs.addEventListener("click", function() {
			xhr = new XMLHttpRequest();
			xhr.onreadystatechange = function(){
				if(xhr.readyState == 4 && xhr.status==200){
					if(includetitle=='true')
					$("fe_text").innerHTML = titulo+' '+ xhr.responseText;				
					else
					$("fe_text").innerHTML = xhr.responseText;									
					var cligsp = $('cligsp');					
					$('user').removeChild(cligsp);
					$("fe_text").select();
					$("fe_text").focus();					
				}		
			}
			var cligsp=document.createElement('span');
			cligsp.innerHTML = 'Shortening please wait...';
			cligsp.id='cligsp';
			$('user').appendChild(cligsp);
			xhr.open('GET','http://cli.gs/api/v1/cligs/create?url='+encodeURIComponent(laurl),true);
			xhr.send(null);			
		}, false);
	}
	/////////////
	var twite = $('postwit');
	if (twite) {		
		twite.addEventListener("click", function() {				
			if($('fe_text').value.length==0)return false;
			xmlh= new XMLHttpRequest();
			xmlh.onreadystatechange = function(){
				if(xmlh.readyState==4){
					var a = $('sent');
					$('d_debug').removeChild(a);
					var p = document.createElement('p');
					if(xmlh.status==200||xmlh.status==304){
						p.innerHTML = 'Status updated!';
					}else{						
						p.innerHTML = 'There was an error!';
					}
					$('d_debug').appendChild(p);	
				}
			}
			var a = document.createElement('p');
			a.id='sent';
			a.innerHTML = 'Sending update!';			
			$('d_debug').appendChild(a);	
			xmlh.open('POST','https://twitter.com/statuses/update.xml',true,user,pass);
			xmlh.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
			xmlh.send("status="+encodeURIComponent($('fe_text').value));
		}, false);
	}
	
	var stwits = $('stwit');
	if (stwits) {		
		stwits.addEventListener("click", function() {				
			//post directly to twitter
			if($('fe_text').value.length>0)
			chrome.tabs.create({url:'http://twitter.com/?status='+encodeURIComponent($("fe_text").value)});
		}, false);
	}
	
	var settings = $('settings');
	if(settings){
		settings.addEventListener("click",function(){
			chrome.tabs.create({url:xtsurl+'/option.html'});
		},false);
	}
	
	var clipboard = $('d_clip_button');
	if(clipboard){	
		clipboard.addEventListener("click", function() {
			var p = document.createElement('p');
			if($('fe_text').value.length >0){
				$('fe_text').select();
				document.execCommand("copy");
				p.innerHTML = 'Copied : '+$('fe_text').value;
			}
			else p.innerHTML = 'Nothing to copy';
			$('d_debug').appendChild(p);		
		},false);
	}
}, 0);

function viewtweets(){
            if ($('fe_text').value.length > 140) {
         	$('d_debug').innerHTML="More than 140 letters!";
                return false;
            } else {
         	$('d_debug').innerHTML="";
                return true;
            }

}       
        
</script>

<div style="width:320px" align="center">
<div id='settings' style="position:absolute">Settings</div>
<div id='user'>&nbsp;</div>
	<textarea id="fe_text"  onKeyUp="viewtweets()"></textarea>
	<div>&nbsp;</div>
	<div id="d_clip_container">
		<span id="d_clip_button">Send to clipboard</span>
		<span id="postwit" style="display:none">Tweet Now</span>
		<span id="stwit">Use Twitter</span>
	</div>
	<div id="d_debug"> </div>
</div>
